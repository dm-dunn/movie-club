// Prisma Schema for Movie Club
// Database: PostgreSQL
// ORM: Prisma 5.x

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// CORE MODELS
// ============================================================================

model User {
  id                String   @id @default(uuid())
  name              String
  username          String   @unique
  email             String?
  password          String
  profilePictureUrl String?  @map("profile_picture_url")
  isAdmin           Boolean  @default(false) @map("is_admin")
  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  ratings           Rating[]
  moviePicks        MoviePick[]
  personalRankings  PersonalRanking[]
  pickerQueue       PickerQueue[]
  votes             Vote[]

  @@map("users")
}

model Movie {
  id                  String    @id @default(uuid())
  title               String
  year                Int?
  runtimeMinutes      Int?      @map("runtime_minutes")
  tmdbId              Int?      @unique @map("tmdb_id")
  posterUrl           String?   @map("poster_url")
  backdropUrl         String?   @map("backdrop_url")
  overview            String?   @db.Text

  // Oscar data
  academyNominations  Int       @default(0) @map("academy_nominations")
  academyWins         Int       @default(0) @map("academy_wins")

  // Status tracking
  status              MovieStatus @default(UNWATCHED)
  watchedDate         DateTime?   @map("watched_date") @db.Date
  watchedBy           String[]    @default([]) @map("watched_by")

  // Metadata
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  // Relations
  ratings             Rating[]
  moviePicks          MoviePick[]
  personalRankings    PersonalRanking[]
  votes               Vote[]

  @@map("movies")
}

enum MovieStatus {
  UNWATCHED
  CURRENT
  WATCHED
}

model MoviePick {
  id        String   @id @default(uuid())
  movieId   String   @map("movie_id")
  userId    String   @map("user_id")
  pickRound Int      @map("pick_round")
  pickedAt  DateTime @default(now()) @map("picked_at")

  // Relations
  movie     Movie    @relation(fields: [movieId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([movieId]) // Each movie picked only once
  @@map("movie_picks")
}

model Rating {
  id      String   @id @default(uuid())
  userId  String   @map("user_id")
  movieId String   @map("movie_id")
  rating  Decimal  @db.Decimal(2, 1) // 1.0 to 5.0
  ratedAt DateTime @default(now()) @map("rated_at")

  // Relations
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  movie   Movie    @relation(fields: [movieId], references: [id], onDelete: Cascade)

  @@unique([userId, movieId]) // One rating per user per movie
  @@map("ratings")
}

model PersonalRanking {
  id      String @id @default(uuid())
  userId  String @map("user_id")
  movieId String @map("movie_id")
  rank    Int    // 1-10

  // Relations
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  movie   Movie  @relation(fields: [movieId], references: [id], onDelete: Cascade)

  @@unique([userId, rank]) // Can't have two movies at same rank
  @@unique([userId, movieId]) // Can't rank same movie twice
  @@map("personal_rankings")
}

model PickerQueue {
  id           String    @id @default(uuid())
  userId       String    @map("user_id")
  position     Int
  roundNumber  Int       @map("round_number")
  isCurrent    Boolean   @default(false) @map("is_current")
  completedAt  DateTime? @map("completed_at")

  // Relations
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([roundNumber, position])
  @@index([roundNumber, position])
  @@index([isCurrent])
  @@map("picker_queue")
}

// ============================================================================
// VOTING SYSTEM (Phase 2)
// ============================================================================

model VotingPeriod {
  id              String    @id @default(uuid())
  year            Int       @unique
  opensAt         DateTime  @map("opens_at")
  closesAt        DateTime  @map("closes_at")
  resultsRevealed Boolean   @default(false) @map("results_revealed")
  createdAt       DateTime  @default(now()) @map("created_at")

  // Relations
  votes           Vote[]

  @@map("voting_periods")
}

model AwardCategory {
  id                 String  @id @default(uuid())
  name               String  @unique
  requiresTextInput  Boolean @default(false) @map("requires_text_input")
  displayOrder       Int     @map("display_order")

  // Relations
  votes              Vote[]

  @@map("award_categories")
}

model Vote {
  id              String   @id @default(uuid())
  votingPeriodId  String   @map("voting_period_id")
  userId          String   @map("user_id")
  categoryId      String   @map("category_id")
  movieId         String   @map("movie_id")
  textInput       String?  @map("text_input") @db.Text
  submittedAt     DateTime @default(now()) @map("submitted_at")

  // Relations
  votingPeriod    VotingPeriod   @relation(fields: [votingPeriodId], references: [id], onDelete: Cascade)
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  category        AwardCategory  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  movie           Movie          @relation(fields: [movieId], references: [id], onDelete: Cascade)

  @@unique([votingPeriodId, userId, categoryId])
  @@index([votingPeriodId])
  @@index([categoryId])
  @@map("votes")
}

// ============================================================================
// INDEXES FOR PERFORMANCE
// ============================================================================

// Additional indexes defined above via @@index directives
