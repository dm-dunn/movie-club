// Prisma Schema for Movie Club
// Database: PostgreSQL
// ORM: Prisma 5.x

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// CORE MODELS
// ============================================================================

model User {
  id                String   @id @default(uuid())
  name              String
  username          String   @unique
  email             String?
  password          String
  profilePictureUrl String?  @map("profile_picture_url")
  isAdmin           Boolean  @default(false) @map("is_admin")
  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  ratings           Rating[]
  moviePicks        MoviePick[]
  personalRankings  PersonalRanking[]
  votes             Vote[]

  @@map("users")
}

model Movie {
  id                  String    @id @default(uuid())
  title               String
  year                Int?
  runtimeMinutes      Int?      @map("runtime_minutes")
  tmdbId              Int?      @unique @map("tmdb_id")
  posterUrl           String?   @map("poster_url")
  backdropUrl         String?   @map("backdrop_url")
  overview            String?   @db.Text

  // Oscar data
  academyNominations  Int       @default(0) @map("academy_nominations")
  academyWins         Int       @default(0) @map("academy_wins")

  // Status tracking
  status              MovieStatus @default(UNWATCHED)
  watchedDate         DateTime?   @map("watched_date") @db.Date
  watchedBy           String[]    @default([]) @map("watched_by")
  averageRating       Decimal?    @map("average_rating") @db.Decimal(3, 2) // 0.00 to 5.00
  viewingSeason       String?     @map("viewing_season") // e.g., "Season 1", "Classic Era"

  // Metadata
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  // Relations
  ratings             Rating[]
  moviePicks          MoviePick[]
  personalRankings    PersonalRanking[]
  votes               Vote[]
  castMembers         CastMember[]
  crewMembers         CrewMember[]

  @@map("movies")
}

enum MovieStatus {
  UNWATCHED
  CURRENT
  WATCHED
}

model MoviePick {
  id        String   @id @default(uuid())
  movieId   String   @map("movie_id")
  userId    String   @map("user_id")
  pickRound Int      @map("pick_round")
  pickedAt  DateTime @default(now()) @map("picked_at")

  // Relations
  movie     Movie    @relation(fields: [movieId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([movieId]) // Each movie picked only once
  @@map("movie_picks")
}

model Rating {
  id      String   @id @default(uuid())
  userId  String   @map("user_id")
  movieId String   @map("movie_id")
  rating  Decimal  @db.Decimal(2, 1) // 1.0 to 5.0
  ratedAt DateTime @default(now()) @map("rated_at")

  // Relations
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  movie   Movie    @relation(fields: [movieId], references: [id], onDelete: Cascade)

  @@unique([userId, movieId]) // One rating per user per movie
  @@map("ratings")
}

model PersonalRanking {
  id      String @id @default(uuid())
  userId  String @map("user_id")
  movieId String @map("movie_id")
  rank    Int    // 1-10

  // Relations
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  movie   Movie  @relation(fields: [movieId], references: [id], onDelete: Cascade)

  @@unique([userId, rank]) // Can't have two movies at same rank
  @@unique([userId, movieId]) // Can't rank same movie twice
  @@map("personal_rankings")
}

model PickingSeason {
  id                  String    @id @default(uuid())
  seasonNumber        Int       @unique @map("season_number")
  availablePickerIds  String[]  @default([]) @map("available_picker_ids")
  usedPickerIds       String[]  @default([]) @map("used_picker_ids")
  currentPickerId     String?   @map("current_picker_id")
  isActive            Boolean   @default(true) @map("is_active")
  createdAt           DateTime  @default(now()) @map("created_at")
  completedAt         DateTime? @map("completed_at")

  @@index([isActive])
  @@map("picking_seasons")
}

// ============================================================================
// VOTING SYSTEM (Phase 2)
// ============================================================================

model VotingPeriod {
  id              String    @id @default(uuid())
  year            Int       @unique
  opensAt         DateTime  @map("opens_at")
  closesAt        DateTime  @map("closes_at")
  resultsRevealed Boolean   @default(false) @map("results_revealed")
  createdAt       DateTime  @default(now()) @map("created_at")

  // Relations
  votes           Vote[]

  @@map("voting_periods")
}

model AwardCategory {
  id                 String  @id @default(uuid())
  name               String  @unique
  requiresTextInput  Boolean @default(false) @map("requires_text_input")
  displayOrder       Int     @map("display_order")

  // Relations
  votes              Vote[]

  @@map("award_categories")
}

model Vote {
  id              String   @id @default(uuid())
  votingPeriodId  String   @map("voting_period_id")
  userId          String   @map("user_id")
  categoryId      String   @map("category_id")
  movieId         String   @map("movie_id")
  textInput       String?  @map("text_input") @db.Text
  submittedAt     DateTime @default(now()) @map("submitted_at")

  // Relations
  votingPeriod    VotingPeriod   @relation(fields: [votingPeriodId], references: [id], onDelete: Cascade)
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  category        AwardCategory  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  movie           Movie          @relation(fields: [movieId], references: [id], onDelete: Cascade)

  @@unique([votingPeriodId, userId, categoryId])
  @@index([votingPeriodId])
  @@index([categoryId])
  @@map("votes")
}

// ============================================================================
// CAST & CREW TRACKING
// ============================================================================

model CastMember {
  id            String @id @default(uuid())
  movieId       String @map("movie_id")
  tmdbPersonId  Int    @map("tmdb_person_id")
  name          String
  gender        Int    // 1=female, 2=male, 0=unknown
  castOrder     Int    @map("cast_order")

  // Relations
  movie         Movie  @relation(fields: [movieId], references: [id], onDelete: Cascade)

  @@unique([movieId, tmdbPersonId])
  @@index([name])
  @@map("cast_members")
}

model CrewMember {
  id            String @id @default(uuid())
  movieId       String @map("movie_id")
  tmdbPersonId  Int    @map("tmdb_person_id")
  name          String
  job           String

  // Relations
  movie         Movie  @relation(fields: [movieId], references: [id], onDelete: Cascade)

  @@unique([movieId, tmdbPersonId, job])
  @@index([name, job])
  @@map("crew_members")
}

// ============================================================================
// GROUP STATISTICS
// ============================================================================

model GroupStats {
  id                        String   @id @default("singleton")
  totalMinutesWatched       Int      @default(0) @map("total_minutes_watched")
  totalOscarNominations     Int      @default(0) @map("total_oscar_nominations")
  totalOscarWins            Int      @default(0) @map("total_oscar_wins")
  mostNominationsMovieTitle String?  @map("most_nominations_movie_title")
  mostNominationsCount      Int      @default(0) @map("most_nominations_count")
  mostWinsMovieTitle        String?  @map("most_wins_movie_title")
  mostWinsCount             Int      @default(0) @map("most_wins_count")
  mostWatchedActorName      String?  @map("most_watched_actor_name")
  mostWatchedActorCount     Int      @default(0) @map("most_watched_actor_count")
  mostWatchedActressName    String?  @map("most_watched_actress_name")
  mostWatchedActressCount   Int      @default(0) @map("most_watched_actress_count")
  mostWatchedDirectorName   String?  @map("most_watched_director_name")
  mostWatchedDirectorCount  Int      @default(0) @map("most_watched_director_count")
  updatedAt                 DateTime @updatedAt @map("updated_at")

  @@map("group_stats")
}

// ============================================================================
// INDEXES FOR PERFORMANCE
// ============================================================================

// Additional indexes defined above via @@index directives
